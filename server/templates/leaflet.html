<!DOCTYPE html>
<html>
<head>

    <title>Quick Start - Leaflet</title>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico"/>

    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>

    <script src="https://yastatic.net/jquery/3.3.1/jquery.min.js"></script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

    <script src="/static/mustache.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"
      integrity="sha384-q2kxQ16AaE6UbzuKqyBE9/u/KzioAlnx2maXQHiDX9d4/zp8Ok3f+M7DPm+Ib6IU"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.min.js"
      integrity="sha384-pQQkAEnwaBkjpqZ8RU1fF1AKtTcHJwFl3pblpTlHXybJjHpMYo79HY3hIi4NKxyj"
      crossorigin="anonymous"></script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <script src="/static/forms.js"></script>
    <script src="/static/models.js"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body {
            height: 100vh;
        }

        
        .map_container {
            
            height: calc(100% - 51px); 
        }

        #mapid {
            height: 100%;
            width: 100%;
        }   
        
        header.navbar {
            margin-bottom: 0px;
        }

        .settings_page {
            position: absolute;
            width: 100%;
            background: transparent;
            z-index: 3000;
            background-color: rgba(200, 200, 200, 0.8);
        }

    </style>
</head>
<body>
<header>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark" aria-label="Fourth navbar example">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">Expand at md</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
    
          <div class="collapse navbar-collapse" id="navbarsExample04">
            <ul class="navbar-nav me-auto mb-2 mb-md-0">
              <li class="nav-item active">
                <a class="nav-link" data-bs-toggle="collapse" href="#nav-trackers-list" role="button" aria-expanded="false" aria-controls="nav-trackers-list">Devices</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="collapse" href="#nav-add-tracker" role="button" aria-expanded="false" aria-controls="nav-add-tracker">Add device</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="collapse" href="#nav-friends" role="button" aria-expanded="false" aria-controls="nav-friends">Friends</a> 
              </li>
              <li class="nav-item">
                <input type="text" name="daterange" class="form-control" value="01/01/2018 - 01/15/2018" id="track_dates"/>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/logout" role="button">Logout</a>
              </li>
            </ul>
          </div>
        
        </div>
      </nav>

      <div class="collapse settings_page" id="nav-trackers-list">
        <div class="card container overflow-auto h-100">
            <div>
            <div class="card-header">
                <div class="container-fluid">
                <span class="text-start">
                    Trackers list
                </span>
                <span class="text-end">
                <button type="button" class="btn-close" aria-label="Close" data-bs-toggle="collapse" href="#nav-trackers-list" aria-expanded="false" aria-controls="#nav-trackers-list" ></button>
                </span>
                </div>
            </div>
            <div class="card-body">
                    <div class="accordion" id="tracker_list"> </div>
            </div>
            </div>
        </div>
        </div>
        <div class="collapse settings_page" id="nav-add-tracker" >
            <div class="card container overflow-auto h-100">
                <div class="card-header text-end">
                    <button type="button" class="btn-close" aria-label="Close" data-bs-toggle="collapse" href="#nav-add-tracker" aria-expanded="false" aria-controls="nav-add-tracker" ></button>
                </div>
                <div class="card-body">
                    <form action="/devices/add" method="post" id="add_device_form" class="needs-validation" novalidate>
                        <div class="mb-3 position-relative">
                            <label for="imeiInput" class="form-label">Imei</label>
                            <input type="text" class="form-control" id="imeiInput" placeholder="imei" name="imei" required>
                            <div class="invalid-tooltip"></div>
                        </div>
                        <div class="mb-3 position-relative">
                            <label for="nameInput" class="form-label">Name</label>
                            <input type="text" class="form-control" id="nameInput" placeholder="name" name="name" required>
                            <div class="invalid-tooltip"></div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">Add device</button>
                        </div>
                    </form> 
                </div>
            </div>    
        </div> 
        <div class="collapse settings_page" id="nav-friends" >
            <div class="card container overflow-auto h-100">
                <div class="card-header text-end">
                    <button type="button" class="btn-close" aria-label="Close" data-bs-toggle="collapse" href="#nav-friends" aria-expanded="false" aria-controls="nav-friends" ></button>
                </div>
                <div class="card-body">
                    <div class="container">
                        <form action="/friends/add" method="post" id="add_friend_form" class="needs-validation" novalidate>
                            <div class="mb-3 position-relative">
                                <label for="nameInput" class="form-label">Name</label>
                                <input type="text" class="form-control" id="nameInput" placeholder="name" name="friend_login" required>
                                <div class="invalid-tooltip"></div>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Offer friendship</button>
                            </div>
                        </form> 
                    </div>
                    <div class="container border-top mt-3">
                        <div class="row row-cols-auto mt-3">
                            <div class="col-lg-6 justify-content-start">Name</div>
                            <div class="col-md-auto">Button</div>
                        </div>
                    </div>
                </div>
            </div>    
        </div> 
</div>
</header>

<div id="map_container" class="map_container">
    <div id="mapid"></div>
</div>

{% raw %}
<script id="trackers_list_entry_template" type="x-tmpl-mustache">
{{#trackers}}
<div class="accordion-item" >
    <h2 class="accordion-header" id="heading_{{imei}}">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_{{imei}}" aria-expanded="true" aria-controls="collapse_{{imei}}">
            {{name}}
        </button>
      </h2>
      <div id="collapse_{{imei}}" class="accordion-collapse collapse" aria-labelledby="heading_{{imei}}" data-bs-parent="#tracker_list">
        <div class="accordion-body">
            <div class="row row-cols-auto mt-3"> 
                <div class="col-lg-6 justify-content-start"> 
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="{{imei}}_enabled" onChange="console.log(devicesModel)">
                        <label class="form-check-label" for="{{imei}}_enabled">Show on map</label>
                    </div>
                </div>
            </div>   
            <div class="row row-cols-auto mt-3">  
                <div class="col-lg-6 justify-content-start"> 
                    <div class="form-check">
                        <input type="color" class="form-control form-control-color" id="{{imei}}_color" onChange="console.log(devicesModel)">
                        <label class="form-check-label" for="{{imei}}_color">Color</label>
                    </div>
                </div>
            </div>
            <div class="row mt-3 justify-content-end"> 
                <div class="col-md-auto"> 
                    <button type="button" class="btn btn-danger btn-sm" id="remove_{{imei}}">Remove</button>
                </div>
            </div>
            <div class="row mt-3 justify-content-end"> 
                <div class="col-md-auto">
                    <button type="button" class="btn btn-secondary btn-sm" id="settings_{{imei}}">Settings</button>
                </div>
            </div> 
        </div>
      </div>
</div>
{{/trackers}}
</script>
{% endraw %}

<div id="settings" class="modal text-sm">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                
            </div>
        </div>
    </div>
  </div>

<script>
    let firstLoad = true;
    let imei = "{{ imei }}";
    let currentPosition = L.latLng(55.750996996, 37.617330864);
    let follow=false;

    function renderDevices(data) {
        console.log(data);
        $("#trackers_list_spinner").addClass("d-none");
        let rendered = Mustache.render($('#trackers_list_entry_template')[0].innerHTML, { 'trackers': data });
        $('#tracker_list')[0].innerHTML = rendered;
    }

    let devicesModel = new Devices(renderDevices, function() {$("#trackers_list_spinner").removeClass("d-none");});
    let friendsModel = new Friends();

    $('#track_dates').daterangepicker({
            timePicker: true,
            "showDropdowns": true,
            "timePicker": true,
            "timePicker24Hour": true,
            "timePickerIncrement": 5,
            "autoApply": true,
            "startDate": "12/26/2020",
            "endDate": "01/01/2021",
            ranges: {
                    'Today': [moment(), moment()],
                    'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                    'This Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                    },
            startDate: moment().startOf('hour'),
            endDate: moment().startOf('hour').add(32, 'hour'),
            locale: {
                format: 'M/DD hh:mm' 
            }

    });
    
	var mymap = L.map('mapid').setView([55.750996996, 37.617330864], 13);

    var baseLayers = {
        'OSM': L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1
        }),

        //2gis:
        '2GIS': L.tileLayer('http://tile2.maps.2gis.com/tiles?x={x}&y={y}&z={z}'),

        //Google Map Streets:
        'GoogleMap': L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {subdomains:['mt0','mt1','mt2','mt3']}),

        //Google Map Terrain:
        'GoogleMapTerrain': L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {subdomains:['mt0','mt1','mt2','mt3']}),

        //Google Map Hybrid:
        'GoogleMapHybrid': L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {subdomains:['mt0','mt1','mt2','mt3']}),

        //Google Map Satellite:
        'GoogleMapSattelite': L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {subdomains:['mt0','mt1','mt2','mt3']}).addTo(mymap),
    };

    L.control.layers(baseLayers, {}).addTo(mymap);

    L.easyButton('fa fa-crosshairs', function(btn, map){
            if (currentPosition != null) {
                mymap.panTo(currentPosition,13);
            }
    }).addTo( mymap );

    var stateChangingButton = L.easyButton({
        states: [ 
        {
                stateName: 'follow_tracker',        // name the state
                icon:      'fa fa-link',               // and define its properties
                title:     'follow tracker',        // like its title
                onClick: function(btn, map) {       // and its callback
                    follow=true;
                    btn.state('dont_follow');    // change state on click!
                }
            },
            {
                stateName: 'dont_follow',
                icon:      'fa fa-chain-broken',
                title:     'Don\'t follow',
                onClick: function(btn, map) {
                    follow=false;
                    btn.state('follow_tracker');
                }
        },
    ]
    });
    stateChangingButton.addTo(mymap);
    
    var marker = new L.Marker(currentPosition);
    marker.addTo(mymap);

    function onLocationFound(e) {
        var radius = e.accuracy;
        L.circle(e.latlng, radius).addTo(mymap);
    }


    //mymap.on('locationfound', onLocationFound);

    let segments = [];
    let last_ts = Math.round(new Date().getTime()/1000) - 48*3600;

    function updateWaypoints() {
        $.ajax({
            url: '/'+imei+'/coordinates',
            data: {
                'since': last_ts
            },
            success: function(data) {
                if (data.length > 0) {
                    let p = data.length - 1;
                    let newPosition = L.latLng(data[p]['lat'], data[p]['lng']);
                    last_ts = data[p]['ts']; 

                    if (firstLoad || follow) {
                        //mymap.flyTo(newPosition);
                        mymap.panTo(newPosition,13);
                        firstLoad=false;
                    }
                    
                    if (currentPosition != newPosition) {
                        currentPosition = newPosition;
                        marker.setLatLng(newPosition);
                        
                        if (segments.length == 0 ||  segments[segments.length-1].getLatLngs().length >= 100) {
                            let track = L.polyline([], {color: 'red'});
                            mymap.addLayer(track);
                            segments.push(track);
                        }
                       
                        data.forEach(el => segments[segments.length-1].addLatLng(el));
                    }

                    mymap.locate({setView: false, maxZoom: 16});
                }            
            }
        });
    }

    setInterval(updateWaypoints, 1000);
    
    devicesModel.reload();

    $('#trackers_list_refresh').on('click', function() { devicesModel.reload() });
    new AjaxForm( $("#add_device_form"), devicesModel.add).init();
    new AjaxForm( $("#add_friend_form"), friendsModel.add).init();

    let pages = {};
    $(".settings_page").each( function() { 
        pages[this.id] = new bootstrap.Collapse(this, {toggle: false});
    });

    let navbarCollapse = new bootstrap.Collapse($("#navbarsExample04")[0],{toggle: false}); 

    function onPageShow(event) {
        let target = event.target;
        let id = target.id;
        
        if (!pages[id]) {
            return;
        }

        for (let i in pages) {
            if (id != i) {
                pages[i].hide();
            }
        }

        $('.settings_page').css("height", $("#map_container").height()+"px"); 
    }

    $(".settings_page").on('show.bs.collapse', () => navbarCollapse.hide());
    $(".settings_page").on('hidden.bs.collapse', (e) => pages[e.target.id] && $("#map_container").removeClass("d-none") );
    $(".settings_page").on('shown.bs.collapse', onPageShow);
    $('.settings_page').bind('click dblclick mouseover mouseout scroll',function(e){ e.stopPropagation();});
    $('#map_container').css("height","calc(100% - "+$("header").height()+"px)"); 

    $(window).resize(function () { 
        $('#map_container').css("height","calc(100% - "+$("header").height()+"px)"); 
        $('.settings_page').css("height", $("#map_container").height()+"px"); 
    });

</script>


</body>
</html>